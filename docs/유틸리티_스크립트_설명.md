# 유틸리티 스크립트 설명

이 문서는 시뮬레이션 및 시각화를 위한 보조 스크립트들을 설명합니다.

## 목차
1. [simulate_xz_potential_map.py](#simulate_xz_potential_mappy)
2. [visualize_efield.py](#visualize_efieldpy)
3. [visualize_neuron_morphology.py](#visualize_neuron_morphologypy)

---

## simulate_xz_potential_map.py

### 개요
X-Z 그리드 상에서 뉴런의 최대 막전위(Max Vm)를 매핑하는 스크립트입니다. 여러 위치에 뉴런을 배치하고, 각 위치에서 E-field에 대한 반응을 측정하여 2D 히트맵으로 시각화합니다.

### 주요 기능
- **X-Z 그리드 시뮬레이션**: 지정된 X, Z 좌표 범위에서 뉴런 반응 측정
- **다중 E-field 스케일**: 여러 배수(1x, 10x, 20x, ...)에 대해 한 번에 시뮬레이션
- **최적화된 실행**: 각 위치에서 뉴런을 한 번만 생성하고, 스케일만 변경하며 반복
- **2D 히트맵 출력**: 최대 막전위를 색상으로 표현한 X-Z 맵

### 설정 파라미터

```python
# --- 0. Simulation Configuration ---
ALLEN_CELL_ID = '486239338'  # 사용할 뉴런 모델 ID

# E-field 스케일 리스트
E_FIELD_SCALES = [1, 10, 20, 30, 40, 50]  # 여러 배수 한 번에 실행

# X-Z 그리드 설정 (tip 기준, um)
X_POSITIONS = np.arange(-300, 301, 20)  # -300 ~ 300, 20um 간격 (31개)
Z_POSITIONS = np.arange(310, 811, 20)   # 310 ~ 810, 20um 간격 (26개)
Y_POSITION = 42.0 * um  # Y 위치 고정

# 시뮬레이션 시간
SIM_TIME_MS = 1.0  # 0 ~ 1 ms

# E-field 적용 방식
E_FIELD_METHOD = 'integrated'  # 'simple' 또는 'integrated'
```

### 출력 파일

| 파일 | 설명 |
|------|------|
| `xz_potential_map_{CELL_ID}_scale{N}x.png` | 스케일별 개별 히트맵 |
| `xz_potential_map_{CELL_ID}_comparison.png` | 모든 스케일 비교 플롯 |
| `xz_potential_data_{CELL_ID}_scale{N}x.npz` | 스케일별 데이터 파일 |
| `xz_potential_data_{CELL_ID}_all_scales.npz` | 통합 데이터 파일 |

### 실행 방법

```bash
python simulate_xz_potential_map.py
```

### 출력 디렉토리
`simulate_xz_output/`

---

## visualize_efield.py

### 개요
Ansys에서 추출한 E-field 데이터를 다양한 방식으로 시각화하는 스크립트입니다. 2D 슬라이스, 3D 시각화, 시간에 따른 변화 등을 표현할 수 있습니다.

### 주요 기능
- **2D 슬라이스 플롯**: X-Y, X-Z, Y-Z 평면의 E-field 분포
- **3D 시각화**: 공간 전체의 E-field 분포
- **시간 변화 플롯**: 특정 위치에서 시간에 따른 E-field 변화
- **뉴런 위치 오버레이**: SimplePyramidal 뉴런 위치를 플롯에 표시
- **다중 시간점 비교**: 여러 시간점의 E-field를 한 번에 비교

### 주요 함수

| 함수 | 설명 |
|------|------|
| `load_data()` | E-field 값과 좌표 데이터 로드 |
| `get_component()` | Ex, Ez, 또는 magnitude 컴포넌트 추출 |
| `filter_slice()` | 특정 축 기준 슬라이스 필터링 |
| `plot_neurons_on_2d()` | 2D 플롯에 뉴런 위치 표시 |
| `plot_neurons_on_3d()` | 3D 플롯에 뉴런 위치 표시 |

### 뉴런 파라미터

```python
# SimplePyramidal 뉴런 파라미터
SOMA_DIAMETER = 30.0  # um
SOMA_LENGTH = 30.0    # um
AXON_LENGTH = 1000.0  # um

# 뉴런 위치 (simulate_tES.py의 N_POSITIONS와 동일)
NEURON_POSITIONS = [
    (-90.0, 42.0, 561.0),  # Neuron 1 (x, y, z in um)
    (0.0, 42.0, 561.0),    # Neuron 2
    (90.0, 42.0, 561.0)    # Neuron 3
]
```

### 환경 자동 감지
- **Windows**: TkAgg 또는 Qt5Agg 백엔드 자동 선택
- **Linux/WSL**: DISPLAY 환경 변수 확인 후 적절한 백엔드 선택
- **Headless**: DISPLAY 없으면 Agg 백엔드로 파일 저장만 지원

### 출력 디렉토리
`visualize_efield_output/`

---

## visualize_neuron_morphology.py

### 개요
Allen Brain Atlas의 SWC 파일을 읽어서 뉴런의 3D 형태를 시각화하는 스크립트입니다.

### 주요 기능
- **SWC 파싱**: SWC 포맷의 morphology 데이터 로드
- **3D 시각화**: 뉴런의 soma, dendrite, axon, apical 구조 표시
- **타입별 색상 구분**: 
  - Soma (red)
  - Dendrite (blue)
  - Axon (green)
  - Apical (purple)
- **부모-자식 연결선**: morphology의 연결 구조 표시
- **시점 각도 조절**: elevation, azimuth 각도 설정 가능

### SWC 타입 정보

| 타입 | 이름 | 색상 | 설명 |
|------|------|------|------|
| 1 | Soma | Red | 세포체 |
| 2 | Dendrite | Blue | 수상돌기 (basal) |
| 3 | Axon | Green | 축삭돌기 |
| 4 | Apical | Purple | 첨단 수상돌기 |

### 명령줄 인터페이스

```bash
# 기본 사용 (Cell ID로 자동 찾기)
python visualize_neuron_morphology.py --cell-id 529898751

# 특정 SWC 파일 지정
python visualize_neuron_morphology.py --swc-file allen_neuron_529898751/reconstruction.swc

# 연결선 없이 점만 표시
python visualize_neuron_morphology.py --cell-id 529898751 --no-connections

# 시점 각도 조정 (elevation=30, azimuth=60)
python visualize_neuron_morphology.py --cell-id 529898751 --view-angle 30 60

# 모든 옵션
python visualize_neuron_morphology.py \
    --cell-id 529898751 \
    --output my_plot.png \
    --line-width 1.5 \
    --point-size-scale 2.0 \
    --view-angle 30 60 \
    --title "My Neuron"
```

### 명령줄 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--swc-file` | SWC 파일 경로 | None |
| `--cell-id` | Cell ID (예: 529898751) | None |
| `--output` | 출력 파일 경로 | 자동 생성 |
| `--no-connections` | 연결선 표시 안 함 | False |
| `--no-color-by-type` | 타입별 색상 구분 안 함 | False |
| `--line-width` | 연결선 두께 | 1.0 |
| `--point-size-scale` | 점 크기 스케일 | 1.0 |
| `--view-angle` | 시점 각도 (elev, azim) | (20, 45) |
| `--title` | 플롯 제목 | 자동 생성 |

### 주요 함수

```python
def parse_swc(swc_file):
    """SWC 파일을 파싱하여 morphology 데이터 반환"""

def get_type_info():
    """SWC 타입별 색상, 크기, 투명도 정보 반환"""

def visualize_morphology_3d(swc_file, output_path=None, ...):
    """3D 시각화 메인 함수"""
```

### 출력 디렉토리
`visualize_morphology_output/`

---

## 요약 비교

| 스크립트 | 용도 | 입력 | 출력 |
|----------|------|------|------|
| `simulate_xz_potential_map.py` | X-Z 그리드 막전위 매핑 | E-field 데이터 + Allen 모델 | 히트맵 PNG + NPZ 데이터 |
| `visualize_efield.py` | E-field 시각화 | E-field NPY 파일 | 2D/3D 플롯 PNG |
| `visualize_neuron_morphology.py` | 뉴런 형태 시각화 | SWC 파일 | 3D 플롯 PNG |

---

## 공통 특징

### 환경 자동 감지
모든 시각화 스크립트는 DISPLAY 환경 변수를 확인하여:
- **Interactive 모드**: 화면에 플롯 표시 (TkAgg/Qt5Agg)
- **Headless 모드**: 파일 저장만 지원 (Agg)

### 진행률 표시
긴 작업에는 `tqdm` 진행률 바 사용:
```
X-Z Grid Simulation: 100%|██████████| 4836/4836 [45:23<00:00,  1.78sim/s]
```

### 스크립트 기준 경로
모든 파일 경로는 스크립트 위치 기준:
```python
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
OUTPUT_DIR = os.path.join(SCRIPT_DIR, 'output_folder')
```
